# üö® ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI AGENTS (MANDATORY RULES) üö®

‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏≠‡∏á USER ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:

### 1. ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ `run_command` tool ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° "Run/Reject"
‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏≤‡∏Å/‡∏ä‡πâ‡∏≤/‡∏ß‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)

### 2. ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô Code Block ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° `<` (Insert to Terminal) ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:**
```powershell
npm run dev
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î:**
(‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Tool run_command ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î Approve)

---
*‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: 2026-02-06 ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á User "‡∏â‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏¢‡∏¢"* 

---

# ü§ñ Specialized AI Agents - Technical Rules & Configuration
**Last Updated:** 2026-02-09
**Status:** Universe Crown Edition (Stable)

## üé® UI/UX Design System (Premium)
‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏° Concept "Universe Crown Edition" ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û

### 1. Color Palette (Inline Styles Required)
‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Tailwind v4 Dynamic Classes ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏µ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ **Inline Styles** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö interactive elements ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Dynamic Color
- **Code Specialist:** `#5E9BEB` (Blue)
- **Creative Director:** `#EB5463` (Red/Pink)
- **Data Strategist:** `#FFCE55` (Yellow)
- **Growth Hacker:** `#9FD369` (Green)
- **Background:** `#EFF2F9` (Light Blue-Grey)

### 2. Typography
- **Font Family:** `Sarabun` (Google Fonts)
- **Rules:**
  - `type-h1`: 36px/48px Bold (Slate-700)
  - `type-h2`: 24px Bold (Slate-800)
  - `type-body`: 16px Regular (Slate-600)
  - **User Text:** ‡πÉ‡∏ä‡πâ `color: #FFFFFF` (Pure White) + `font-semibold` ‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Contrast ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô Slate-800
  - **AI Text:** ‡πÉ‡∏ä‡πâ `text-slate-600` (Deep Gray) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤

### 3. Layout Architecture
- **Structure:** 2-Column Standard (Left 5 : Right 7)
- **Behavior:** `CommandCenter` (Left) ‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏∂‡∏á‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ `sticky top-12` (Freeze) ‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£ Scroll ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤
- **Responsive:** Mobile ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á Stack ‡∏Å‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà Sticky)

### 4. Tailwind CSS v4 Configuration
**‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!** ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Tailwind v4 ‡∏ã‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Config ‡πÄ‡∏â‡∏û‡∏≤‡∏∞:
- **dependency:** `@tailwindcss/postcss` (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ `tailwindcss` plugin ‡πÄ‡∏Å‡πà‡∏≤)
- **postcss.config.js:**
  ```js
  module.exports = {
    plugins: {
      '@tailwindcss/postcss': {}, // Must use this package
    },
  }
  ```
- **globals.css:** ‡πÉ‡∏ä‡πâ `@import "tailwindcss";` ‡πÅ‡∏ó‡∏ô `@tailwind base;`

---

## ‚öôÔ∏è Core Logic & State Management

### 1. Voice Input (Robust Handling)
- **Input Sync:** Voice Input -> Chat Input ‡∏à‡∏∞ Sync ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Loop
- **Auto Clear:** ‡πÄ‡∏°‡∏∑‡πà‡∏≠ `onSend` ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô -> `voice.setInput('')` ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á

### 2. Session Management
- **Current Behavior:** Session ID ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà Refresh ‡∏´‡∏£‡∏∑‡∏≠ Load ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (`Math.random()`)
- **Reason:** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° Context ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠ (Stateless Session)
- **Note:** ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Persistent Session ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ `DisplayPanel` ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á ID ‡∏à‡∏≤‡∏Å `localStorage`

### 3. Hydration Error Fixes
- ‡πÉ‡∏ä‡πâ `useEffect` ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Server ‡πÅ‡∏•‡∏∞ Client Render ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠

---

## üö´ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥ (Do Not Touch)
1. **‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö `postcss.config.js`:** ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ CSS ‡∏û‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö
2. **‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô `bg-slate-800` ‡∏Ç‡∏≠‡∏á User Bubble:** ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà User approve ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö Text ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
3. **‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏≠‡∏≤ `sticky` ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Left Column:** ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ UX ‡πÄ‡∏™‡∏µ‡∏¢ (‡∏ß‡∏á‡πÅ‡∏ï‡∏Å)

*‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: Antigravity Agent (Code Specialist)*

---

# üìÅ File Upload System & Vision API Integration
**Added:** 2026-02-13  
**Status:** Phase 2 Complete ‚úÖ

## üéØ Architecture Overview

### Data Flow:
```
User ‚Üí Upload ‚Üí Neon DB (Base64) ‚Üí Redis (Metadata only) ‚Üí Claude Vision API
```

### Key Components:
- `app/api/upload/route.ts` - Upload endpoint (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Neon)
- `hooks/useChat.ts` - Upload logic + State management
- `components/CommandCenter.tsx` - Upload UI
- `components/DisplayPanel.tsx` - Image display in chat
- `lib/attachment/attachment-persistence.ts` - Database operations
- `lib/agent/orchestrator.ts` - Vision API integration
- `lib/state/redis-state.ts` - Hot state management

---

## üî• Critical Design Decisions

### 1. Base64 Storage Strategy (MUST FOLLOW!)

**‚ùå ‡∏´‡πâ‡∏≤‡∏°:** ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡πÉ‡∏ô Redis (‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ~1MB/‡∏£‡∏π‡∏õ)  
**‚úÖ ‡∏ï‡πâ‡∏≠‡∏á:** ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡πÉ‡∏ô Neon Database (`metadata.base64`)  
**‚úÖ ‡∏ï‡πâ‡∏≠‡∏á:** Redis ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà metadata (id, filename, mimeType)

**‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:**
- Redis ‡∏°‡∏µ memory limit
- Base64 ‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å (1 ‡∏£‡∏π‡∏õ = 1-5MB)
- ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Database ‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (lazy loading)

**Implementation:**
```typescript
// ‚ùå ‡∏ú‡∏¥‡∏î - ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡πÉ‡∏ô Redis
await redis.set('conv:123', {
  messages: [{ attachments: [{ metadata: { base64: '...' } }] }]
});

// ‚úÖ ‡∏ñ‡∏π‡∏Å - ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà ID
await redis.set('conv:123', {
  messages: [{ attachments: [{ id: 'abc', filename: 'cat.jpg' }] }]
});

// ‡∏î‡∏∂‡∏á Base64 ‡∏à‡∏≤‡∏Å Database ‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
const attachments = await getAttachmentsByIds(['abc']);
```

---

### 2. Context Window with Images

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:** AI ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤  
**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:** Hydrate attachments ‡∏à‡∏≤‡∏Å Database ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Claude

**Implementation in `orchestrator.ts`:**
```typescript
// Collect attachment IDs from context
const allAttachmentIds = contextWindow
  .flatMap(m => m.attachments?.map(a => a.id) || []);

// Fetch base64 from database
const hydratedAttachments = await getAttachmentsByIds(allAttachmentIds);

// Map back to messages
const messages = contextWindow.map(m => ({
  role: m.role,
  content: m.role === 'user' && m.attachments
    ? buildVisionContent(m.content, hydrateAttachments(m.attachments))
    : m.content
}));
```

---

### 3. Foreign Key Constraints

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:** Upload ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Conversation ‚Üí FK constraint error  
**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:** ‡∏ó‡∏≥ `conversation_id` ‡πÅ‡∏•‡∏∞ `user_id` ‡πÄ‡∏õ‡πá‡∏ô NULLABLE

```sql
-- ‚ùå ‡∏ú‡∏¥‡∏î
conversation_id UUID REFERENCES conversations(id) NOT NULL

-- ‚úÖ ‡∏ñ‡∏π‡∏Å
conversation_id UUID REFERENCES conversations(id) -- nullable
```

---

## üìä Database Schema

```sql
-- attachments table
CREATE TABLE attachments (
  id UUID PRIMARY KEY,
  conversation_id UUID REFERENCES conversations(id), -- NULLABLE
  user_id UUID REFERENCES users(id), -- NULLABLE
  filename VARCHAR(255) NOT NULL,
  mime_type VARCHAR(50) NOT NULL,
  size INTEGER NOT NULL,
  url TEXT NOT NULL,
  storage_key VARCHAR(255),
  metadata JSONB, -- Contains base64 data
  uploaded_at TIMESTAMP DEFAULT NOW()
);

-- image_analyses table
CREATE TABLE image_analyses (
  id UUID PRIMARY KEY,
  attachment_id UUID REFERENCES attachments(id),
  agent_type VARCHAR(50),
  analysis TEXT,
  summary TEXT,
  confidence NUMERIC,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (DO NOT)

‚ùå **‡∏´‡πâ‡∏≤‡∏°** ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡πÉ‡∏ô Redis  
‚ùå **‡∏´‡πâ‡∏≤‡∏°** ‡πÉ‡∏ä‡πâ `NOT NULL` ‡∏Å‡∏±‡∏ö `conversation_id` ‡πÉ‡∏ô attachments  
‚ùå **‡∏´‡πâ‡∏≤‡∏°** ‡∏™‡πà‡∏á attachments ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ `id`  
‚ùå **‡∏´‡πâ‡∏≤‡∏°** ‡∏•‡∏∑‡∏° hydrate attachments ‡πÉ‡∏ô context window  

---

## ‚úÖ Best Practices ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

‚úÖ **‡∏ï‡πâ‡∏≠‡∏á** ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡πÉ‡∏ô Database ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô  
‚úÖ **‡∏ï‡πâ‡∏≠‡∏á** ‡∏î‡∏∂‡∏á Base64 ‡∏à‡∏≤‡∏Å Database ‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ  
‚úÖ **‡∏ï‡πâ‡∏≠‡∏á** Strip Base64 ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Redis  
‚úÖ **‡∏ï‡πâ‡∏≠‡∏á** Hydrate attachments ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Claude  
‚úÖ **‡∏ï‡πâ‡∏≠‡∏á** ‡πÉ‡∏ä‡πâ `getAttachmentsByIds` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bulk fetch

---

*‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: Antigravity Agent - File Upload System Implementation*

